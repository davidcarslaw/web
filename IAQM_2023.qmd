---
format:
  revealjs: 
    theme: ["theme/theme.scss"]
    code-copy: true
    center-title-slide: false
    code-link: true
    code-overflow: wrap
    code-line-numbers: false
    highlight-style: a11y
    height: 1080
    width: 1920
    slide-number: c/t
    preview-links: auto
   # logo: "images/UOY-logo.svg"
  #  footer: <https://davidcarslaw.github.io/web/IAQM_2023.html>
execute: 
  eval: true
  echo: true
  message: false
  warning: false
  freeze: auto
---

##  {background-color="white"}

![](images/plume.png){.absolute top="550" left="660" width="500"}

<h1>Recent developments in the `openair` suite of data analysis packages</h1>

<h2>Measuring Air Quality 2023</h2>

<br>

<p>**David Carslaw**</p>

<p>Department of Chemistry, University of York</p>

<p>Ricardo Energy & Environment</p>

<p>28th March 2023</p>

::: footer
<https://davidcarslaw.github.io/web/IAQM_2023.html>
:::

# Overview {background="#43464B" background-image="images/Mill-chimneys.jpg"}

<br> <br>

<h2>

1.  Accessing UK Air Quality Data

2.  Examples of `openair` Functions

3.  'De-weathering' Air Quality Data

</h2>

## `openair`

<hr>

A package of tools developed in open source software called R specifically designed for air quality data analysis

::: columns
::: {.column width="40%"}
-   Used extensively worldwide by academia, the public and private sectors

-   Many functions covering a wide range of issues

    -   Data import from extensive UK networks
    -   Directional analysis
    -   Source attribution
    -   Back trajectories
    -   Model evaluation
    -   Utility functions

-   Over 400,000 downloads

-   Sister packages: `{openairmaps}`, `{worldmet}` and `deweather`
:::

::: {.column width="60%"}
<br> [![](images/openair_book.png)](https://bookdown.org/david_carslaw/openair/)
:::
:::

##  {background="#43464B"}

<h1>Accessing UK Air Quality Data</h1>

## Air quality sites available in the UK

<hr>

<br> There **a lot** of air quality sites available across many networks accessible by `{openair}`

::: columns
::: {.column width="40%"}
-   AURN, national and local networks

-   'Local' networks include the London Air Quality Network, and networks from Sussex, Essex, Kent, North Lincolnshire, ...

-   For example, in 2023 there are:

    -   **373** Urban Traffic sites measuring NO~2~

    -   129 ozone sites operational in 2023

::: footer
Thanks to Trevor Davies at Ricardo Energy & Environment
:::
:::

::: {.column width="60%"}
<br> ![](images/uk_sites.png){.absolute top="220" left="800" width="1200"}
:::
:::

## Lots of pre-calculated statistics available

<hr>

<br>

> Annual, monthly, daily, daily maximum 8-hour, DAQI, ... with data capture rates

<br>

```{r}
#| echo: false
library(openair)
library(openairmaps)
library(tidyverse)
```

```{r}
annual_aurn <- importAURN(year = 2022, data_type = "annual")
glimpse(annual_aurn)
```

## `openairmaps` for air quality network information

<hr>

<br>

Look at sites in the AURN, Air Quality England and local networks...

```{r}
#| label: londonannulus
#| out-width: "100%"
#| out-height: "700"
networkMap(source = c("aurn", "aqe", "local"), 
           cluster = FALSE)
```

::: footer
A big thanks to Dr Jack Davison
:::

## `openairmaps` for air quality network information

<hr>

<br>

Look at sites in the AURN, Air Quality England and local networks...**that were open between 2015 and 2023** (useful for trend analysis)

```{r}
#| out-width: "100%"
#| out-height: "700"
#| code-line-numbers: "2"
#| cache: true
networkMap(source = c("aurn", "aqe", "local"), cluster = FALSE,
           year = 2015:2023)
```

::: footer
A big thanks to [Dr Jack Davison](https://github.com/jack-davison)!
:::

## Polar plots

<hr>

::: columns
::: {.column width="40%"}
-   Useful for local source attribution

-   Just considering concentration by wind direction only tells us about the direction of major sources

-   Considering the joint wind speed-direction variation says much more about the **nature** of the emission sources

![](images/stability_plume.png)
:::

::: {.column width="60%"}
```{r}
#| fig-width: 4.5
#| fig-height: 4
#| out-width: 20%
#| layout-ncol: 2
#| echo: false
#| cache: true
load("~/My Drive/Research/polarCPF/Scunthorpe 2009.RData") 
scun$lat <- 53.58634
scun$lon <- -0.636811

percentileRose(scun, method = "cpf", percentile = 75,
               pollutant = "nox", col = "grey30", smooth = TRUE)

polarPlot(scun, pollutant = "nox", cols = "YlGnBu")

percentileRose(scun, method = "cpf", percentile = 75,
               pollutant = "so2", col = "grey30", smooth = TRUE)


polarPlot(scun, pollutant = "so2", cols = "YlGnBu")
```
:::
:::

## Source apportionment with polar plots

<hr>

If we have a whole network of sites, we can triangulate potential sources. For example, where do the highest 10% of concentrations of PM~10~ come from?

::: panel-tabset
### Polar plots

-   Import data and manipulate to access meteorological data
-   Plot the probability of exceeding the 90th percentile concentration with satellite base map

```{r}
#| label: nlincs
#| cache: true
#| output-location: column
#| out-width: "100%"
#| out-height: "550"

# get data
nlincs_local <- importLocal(
  c("SCN6", "SC12", "SC10", "AMVL"), 
  year = 2021, meta = TRUE
)
nlincs_aurn <- importAURN(
  c("SCN2"), 
  year = 2021, meta = TRUE
)
# combine
nlincs_all <- bind_rows(
  nlincs_local, nlincs_aurn
)
# reuse modelled met for local data
nlincs_all <-
  nlincs_all %>%
  select(-ws, -wd, -air_temp) %>%
  left_join(
    select(nlincs_aurn, date, ws:air_temp), 
    by = join_by(date)
  )
# polar plot map!
polarMap(
  nlincs_all, "pm10", alpha = 3 / 4,
  statistic = "cpf", percentile = 90,
  cols = "YlGnBu",
  provider = "Esri.WorldImagery"
)
```

### Polar annulus

-   Hourly variation in PM~10~ by wind direction
-   Different base maps

```{r}
#| output-location: column
#| out-width: "100%"
#| out-height: "550"


annulusMap(
    nlincs_all, "pm10", 
    alpha = 3 / 4,
    # use multiple providers
    provider = c("Stamen.Toner", "Esri.WorldImagery")
)
```
:::

## Tracking changes in sources

<hr>

-   Polar plots can be very useful for tracking changes in different source contributions

-   In this case the **difference** in concentrations of SO~2~ and PM~10~ are considered between the periods 2010/2011 and 2020/2021

::: columns
::: {.column width="47%"}
**SO~2~**

```{r}
#| echo: false
#| fig-width: 4.5
#| fig-height: 4
#| fig-keep: 'last'
#| out-width: "80%"
#| cache: true
library(openair)
scun_aurn <- read_rds("scun_aurn_2010_2021.rds")
polarDiff(selectByDate(scun_aurn, year = 2010:2011), 
          selectByDate(scun_aurn, year = 2020:2021), 
          pollutant = "so2", limits = c(-35, 35))

```
:::

::: {#vcenter .column width="47%"}
**PM~10~**

```{r}
#| echo: false
#| fig-width: 4.5
#| fig-height: 4
#| fig-keep: 'last'
#| out-width: "80%"
polarDiff(selectByDate(scun_aurn, year = 2010:2011), 
          selectByDate(scun_aurn, year = 2020:2021), 
          pollutant = "pm10")
```
:::
:::

## Source attribution with back trajectories

<hr>

::: columns
::: {.column width="35%"}
-   Interest is in knowing source origins and contributions
-   Most relevant for regional pollutants such as PM~2.5~ and PM~10~
-   `{openair}` has a range of back trajectory modelling techniques available
-   Use of the NOAA Hysplit model to pre-calculate back trajectories

> Example for PM~2.5~ at North Kensignton in London
:::

::: {.column width="65%"}
![](images/SQTBA.png)
:::
:::

##  {background="#43464B"}

<h1>Deweathering Air Quality Data</h1>

## Dominant meteorology

<hr>

<br>

-   Much of the time we are happy to analyse data as we find it
-   However, meteorology can mask or emphasise things we are interested in
    -   Trends affected more by the weather than by changes in emissions
-   Detecting change --- is it due to an intervention that affects emissions or by the weather?
    -   Many sophisticated change-point methods but the elephant in the room is often meteorology
    -   Things would be much easier if the weather was the same every day!
-   Extensions to `{openair}` can 'deweather' time series of air quality data --- now widely used globally with the Covid-19 interest

# A good vintage! {background="#43464B" background-image="images/Wine-Vintage.jpeg"}

<br>

::: columns
::: {.column width="35%"}
::: incremental
-   <font size="+10">We tend to describe air quality in terms of "good" or "bad" years; like wine!</font>

-   <font size="+10">Important to know whether things have improved (or got worse) because of the weather or emissions</font>

-   <font size="+10">A more quantitative approach is required ...</font>
:::
:::
:::

## Useful links

-   Read more about `openair` in the on-line book <https://bookdown.org/david_carslaw/openair/>

-   Browse the source code on GitHub at <https://github.com/davidcarslaw/openair>

-   Published papers on polar plots and deweathering:

    -   Grange, Stuart K, Alastair C Lewis, and David C Carslaw. 2016."Source Apportionment Advances Using Polar Plots of Bivariate Correlation and Regression Statistics."*Atmospheric Environment* 145: 128--34.

    -   Uria-Tellaetxe, I, and D. C. Carslaw. 2014."Conditional Bivariate Probability Function for Source Identification."*Environmental Modelling & Software* 59: 1--9. <https://doi.org/10.1016/j.envsoft.2014.05.002>.

    -   Carslaw, D. C., and S. D. Beevers. 2013. "Characterising and Understanding Emission Sources Using Bivariate Polar Plots and k-Means Clustering."*Environmental Modelling & Software* 40 (0): 325--29. <https://doi.org/10.1016/j.envsoft.2012.09.005>.

    -   Grange, S. K. and Carslaw, D. C. (2019) 'Using meteorological normalisation to detect interventions in air quality time series', Science of The Total Environment. 653, pp. 578--588. <https://doi.org/10.1016/j.scitotenv.2018.10.344>.

    -   Grange, S. K., Lee, J. D., Drysdale, W. S., Lewis, A. C., Hueglin, C., Emmenegger, L. and D. C. Carslaw, (2021). COVID-19 lockdowns highlight a risk of increasing ozone pollution in European urban areas. Atmospheric Chemistry and Physics, 21, 4169--4185, <https://doi.org/10.5194/acp-21-4169-2021>.
